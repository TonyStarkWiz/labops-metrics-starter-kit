<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabOps Metrics Starter Kit - Interactive Demo</title>
    <meta name="description" content="Interactive demo of laboratory operations metrics and analytics platform with Data Quality Rules Engine and Teams Stand-up Bot">
    <meta name="keywords" content="labops, laboratory, metrics, analytics, data quality, teams bot, interactive demo">
    <meta name="author" content="LabOps Team">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://TonyStarkWiz.github.io/labops-metrics-starter-kit/">
    <meta property="og:title" content="LabOps Metrics Starter Kit - Interactive Demo">
    <meta property="og:description" content="Try the interactive demo of our laboratory operations platform">
    <meta property="og:image" content="https://TonyStarkWiz.github.io/labops-metrics-starter-kit/assets/images/labops-banner.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://TonyStarkWiz.github.io/labops-metrics-starter-kit/">
    <meta property="twitter:title" content="LabOps Metrics Starter Kit - Interactive Demo">
    <meta property="twitter:description" content="Try the interactive demo of our laboratory operations platform">
    <meta property="twitter:image" content="https://TonyStarkWiz.github.io/labops-metrics-starter-kit/assets/images/labops-banner.png">

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Papa Parse for CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 5px;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: #666;
            font-size: 1.1rem;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
            text-align: center;
        }

        /* Data Quality Section */
        .dq-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dq-panel {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dq-panel h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease;
            margin-bottom: 1rem;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .rule-builder {
            margin-top: 1rem;
        }

        .rule-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .rule-item h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .rule-item p {
            color: #666;
            font-size: 0.9rem;
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rule-type {
            font-weight: 600;
            color: #28a745;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .rule-details {
            color: #333;
            font-size: 0.9rem;
        }

        .rule-item.active {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .rule-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .rule-checkbox:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .rule-checkbox input[type="checkbox"] {
            margin-top: 0.25rem;
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .rule-checkbox label {
            cursor: pointer;
            flex: 1;
        }

        .rule-checkbox.checked {
            background: #e8f5e8;
            border-color: #28a745;
        }

        /* Teams Bot Section */
        .teams-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .standup-form {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .message-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .message-preview h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .message-preview .content {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        /* Results Section */
        .results-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-title {
            font-size: 1.5rem;
            color: #333;
        }

        .results-actions {
            display: flex;
            gap: 0.5rem;
        }

        .violation-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .violation-item.error {
            background: #fff5f5;
            border-color: #fed7d7;
        }

        .violation-item.warning {
            background: #fffbeb;
            border-color: #fef3c7;
        }

        .violation-item.info {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .violation-type {
            font-weight: 600;
            color: #e53e3e;
        }

        .violation-type.warning {
            color: #d69e2e;
        }

        .violation-type.info {
            color: #3182ce;
        }

        .violation-details {
            color: #666;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dq-container {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                background: transparent;
                padding: 0;
            }
            
            .nav-tab {
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* Dashboard Actions */
        .dashboard-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .data-status {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #e9ecef;
        }

        #refreshChartsBtn {
            background: #667eea;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        #refreshChartsBtn:hover {
            background: #5a6fd8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo">🧪 LabOps Metrics Demo</a>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
                    <button class="nav-tab" onclick="showTab('data-quality')">🔍 Data Quality</button>
                    <button class="nav-tab" onclick="showTab('teams-bot')">🤖 Teams Bot</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #333; margin-bottom: 1rem;">📊 LabOps Metrics Dashboard</h2>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn btn-primary" onclick="updateDashboardCharts()" id="refreshChartsBtn">
                            🔄 Refresh Charts
                        </button>
                        <span class="data-status" id="dataStatus" style="color: #666; font-style: italic;">No data loaded</span>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalSpecimens">0</div>
                        <div class="metric-label">Total Specimens</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgTAT">0 hrs</div>
                        <div class="metric-label">Avg TAT (Hours)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalDepartments">0</div>
                        <div class="metric-label">Departments</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dataQualityScore">0%</div>
                        <div class="metric-label">Data Quality Score</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-container">
                    <h3 class="chart-title">📈 Turnaround Time Trends</h3>
                    <canvas id="tatChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">📊 Daily Throughput</h3>
                    <canvas id="throughputChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">🎯 Error Rate by Department</h3>
                    <canvas id="errorChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Data Quality Tab -->
            <div id="data-quality" class="tab-content">
                <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">🔍 Data Quality Rules Engine</h2>
                
                <div class="dq-container">
                    <!-- CSV Upload Panel -->
                    <div class="dq-panel">
                        <h3>📁 Upload CSV Data</h3>
                        <div class="file-upload" id="fileUpload" onclick="document.getElementById('csvFile').click()">
                            <p>📤 Click to upload CSV or drag & drop</p>
                            <p style="font-size: 0.9rem; color: #666;">Supports: .csv files</p>
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                        
                        <div id="sampleDataSection" style="margin-top: 1rem;">
                            <p style="margin-bottom: 1rem; color: #666;">Or use sample data:</p>
                            <button class="btn btn-secondary" onclick="loadSampleData()">📊 Load Sample Lab Data</button>
                        </div>
                    </div>

                    <!-- Rules Configuration Panel -->
                    <div class="dq-panel">
                        <h3>⚙️ Data Quality Rules</h3>
                        
                        <!-- Rule Upload Section -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #333;">📁 Upload Rules File</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">Upload a JSON or YAML file with your data quality rules</p>
                                <input type="file" id="rulesFile" accept=".json,.yaml,.yml" style="margin-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="uploadRulesFile()">📤 Upload Rules</button>
                                <button class="btn btn-secondary" onclick="downloadSampleRules()" style="margin-left: 0.5rem;">📥 Download Sample</button>
                            </div>
                        </div>

                        <!-- Quick Rule Selection -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #333;">✅ Quick Rule Selection</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="rule-checkbox">
                                    <input type="checkbox" id="rule-required" onchange="toggleRule('required_columns')">
                                    <label for="rule-required">
                                        <strong>Required Columns</strong><br>
                                        <span style="font-size: 0.9rem; color: #666;">Ensures all mandatory columns are present</span>
                                    </label>
                                </div>
                                <div class="rule-checkbox">
                                    <input type="checkbox" id="rule-datatype" onchange="toggleRule('data_type')">
                                    <label for="rule-datatype">
                                        <strong>Data Type Validation</strong><br>
                                        <span style="font-size: 0.9rem; color: #666;">Validates data types for each column</span>
                                    </label>
                                </div>
                                <div class="rule-checkbox">
                                    <input type="checkbox" id="rule-range" onchange="toggleRule('range')">
                                    <label for="rule-range">
                                        <strong>Range Validation</strong><br>
                                        <span style="font-size: 0.9rem; color: #666;">Checks values are within acceptable ranges</span>
                                    </label>
                                </div>
                                <div class="rule-checkbox">
                                    <input type="checkbox" id="rule-completeness" onchange="toggleRule('completeness')">
                                    <label for="rule-completeness">
                                        <strong>Completeness Check</strong><br>
                                        <span style="font-size: 0.9rem; color: #666;">Ensures no missing values in critical fields</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Rule Builder -->
                        <div>
                            <h4 style="margin-bottom: 1rem; color: #333;">🔧 Manual Rule Builder</h4>
                            <div class="rule-builder">
                                <div class="rule-item">
                                    <h4>Required Columns</h4>
                                    <p>Ensures all mandatory columns are present</p>
                                    <button class="btn btn-primary" onclick="addRequiredColumnsRule()">Add Rule</button>
                                </div>
                                <div class="rule-item">
                                    <h4>Data Type Validation</h4>
                                    <p>Validates data types for each column</p>
                                    <button class="btn btn-primary" onclick="addDataTypeRule()">Add Rule</button>
                                </div>
                                <div class="rule-item">
                                    <h4>Range Validation</h4>
                                    <p>Checks values are within acceptable ranges</p>
                                    <button class="btn btn-primary" onclick="addRangeRule()">Add Rule</button>
                                </div>
                                <div class="rule-item">
                                    <h4>Completeness Check</h4>
                                    <p>Ensures no missing values in critical fields</p>
                                    <button class="btn btn-primary" onclick="addCompletenessRule()">Add Rule</button>
                                </div>
                            </div>
                        </div>
                    </div>

                                    <!-- Active Rules Display -->
                <div style="margin-top: 2rem;">
                    <h3>📋 Active Validation Rules</h3>
                    <div id="activeRules">
                        <p style="color: #666; font-style: italic;">No rules added yet. Click the buttons above to add validation rules.</p>
                    </div>
                </div>

                <!-- Data Preview -->
                <div style="margin-top: 2rem;">
                    <h3>📊 Data Preview</h3>
                    <div id="dataPreview">
                        <p style="color: #666; font-style: italic;">Upload a CSV file to see data preview</p>
                    </div>
                    
                    <!-- Manual Chart Update -->
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn btn-primary" onclick="forceUpdateCharts()" style="margin-right: 1rem;">
                            🔄 Force Update Charts
                        </button>
                        <button class="btn btn-secondary" onclick="showDataDebug()">
                            🐛 Show Data Debug
                        </button>
                    </div>
                </div>

                    <!-- Custom Rule Builder -->
                    <div style="margin-top: 2rem;">
                        <h3>🔧 Custom Rule Builder</h3>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Rule Type:</label>
                                    <select id="customRuleType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="custom_range">Custom Range</option>
                                        <option value="custom_completeness">Custom Completeness</option>
                                        <option value="custom_format">Custom Format</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Column Name:</label>
                                    <input type="text" id="customColumn" placeholder="e.g., tat_hours" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div id="customRuleParams" style="margin-bottom: 1rem;">
                                <!-- Dynamic parameters will be inserted here -->
                            </div>
                            <button class="btn btn-primary" onclick="addCustomRule()">➕ Add Custom Rule</button>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Validation Results -->
                <div id="validationResults" class="results-container" style="display: none;">
                    <div class="results-header">
                        <h3 class="results-title">🔍 Validation Results</h3>
                        <div class="results-actions">
                            <button class="btn btn-secondary" onclick="exportResults()">📥 Export Results</button>
                            <button class="btn btn-success" onclick="clearResults()">🧹 Clear</button>
                        </div>
                    </div>
                    <div id="violationsList"></div>
                </div>

                <!-- Run Validation Button -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="runValidation()" id="runValidationBtn" style="font-size: 1.2rem; padding: 1rem 2rem;">
                        🚀 Run Data Quality Validation
                    </button>
                </div>
            </div>

            <!-- Teams Bot Tab -->
            <div id="teams-bot" class="tab-content">
                <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">🤖 Microsoft Teams Stand-up Bot</h2>
                
                <div class="teams-container">
                    <h3>📝 Create Stand-up Update</h3>
                    
                    <form class="standup-form" id="standupForm">
                        <div class="form-group">
                            <label for="teamName">Team Name</label>
                            <input type="text" id="teamName" value="Lab Operations Team" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="yesterday">What did you accomplish yesterday?</label>
                            <textarea id="yesterday" rows="3" placeholder="List your key achievements from yesterday..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="today">What will you work on today?</label>
                            <textarea id="today" rows="3" placeholder="Outline your priorities for today..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="blockers">Any blockers or challenges?</label>
                            <textarea id="blockers" rows="2" placeholder="Describe any issues preventing progress..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="template">Template Style</label>
                            <select id="template">
                                <option value="professional">Professional</option>
                                <option value="casual">Casual</option>
                                <option value="detailed">Detailed</option>
                                <option value="concise">Concise</option>
                            </select>
                        </div>
                    </form>

                    <div style="text-align: center; margin: 2rem 0;">
                        <button class="btn btn-primary" onclick="previewMessage()">👀 Preview Message</button>
                        <button class="btn btn-success" onclick="sendToTeams()">📤 Send to Teams</button>
                        <button class="btn btn-secondary" onclick="loadSampleStandup()">📋 Load Sample</button>
                    </div>

                    <!-- Message Preview -->
                    <div id="messagePreview" class="message-preview" style="display: none;">
                        <h4>📱 Teams Message Preview</h4>
                        <div class="content" id="previewContent"></div>
                    </div>

                    <!-- Success Message -->
                    <div id="successMessage" class="alert alert-success" style="display: none;">
                        ✅ Message sent successfully to Teams! (Simulated)
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentData = null;
        let currentRules = [];
        let charts = {};

        // Initialize the demo
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setCurrentDate();
            loadSampleData();
        });

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Initialize charts
        function initializeCharts() {
            // TAT Chart
            const tatCtx = document.getElementById('tatChart').getContext('2d');
            charts.tat = new Chart(tatCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Avg TAT (Hours)',
                        data: [2.1, 2.3, 2.0, 2.5, 2.2, 2.8, 2.4],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Throughput Chart
            const throughputCtx = document.getElementById('throughputChart').getContext('2d');
            charts.throughput = new Chart(throughputCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Specimens/Hour',
                        data: [142, 156, 148, 162, 155, 138, 145],
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Error Chart
            const errorCtx = document.getElementById('errorChart').getContext('2d');
            charts.error = new Chart(errorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Chemistry', 'Hematology', 'Microbiology', 'Immunology'],
                    datasets: [{
                        data: [0.8, 1.2, 1.5, 0.9],
                        backgroundColor: [
                            '#ff6384',
                            '#36a2eb',
                            '#ffce56',
                            '#4bc0c0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Update dashboard charts with uploaded data
        function updateDashboardCharts() {
            if (!currentData || currentData.length === 0) {
                showAlert('No data available to update charts', 'warning');
                return;
            }

            try {
                console.log('Processing data for charts:', currentData);
                
                // Process the data for charts
                const processedData = processDataForCharts(currentData);
                console.log('Processed data:', processedData);
                
                // Update TAT Chart
                if (charts.tat) {
                    charts.tat.data.labels = processedData.dates;
                    charts.tat.data.datasets[0].data = processedData.avgTAT;
                    charts.tat.update();
                }

                // Update Throughput Chart
                if (charts.throughput) {
                    charts.throughput.data.labels = processedData.dates;
                    charts.throughput.data.datasets[0].data = processedData.throughput;
                    charts.throughput.update();
                }

                // Update Error Chart
                if (charts.error) {
                    charts.error.data.labels = processedData.departments;
                    charts.error.data.datasets[0].data = processedData.errorRates;
                    charts.error.update();
                }

                showAlert('Dashboard charts updated with new data!', 'success');
                
                // Update summary metrics
                updateSummaryMetrics(processedData);
                
            } catch (error) {
                console.error('Error updating charts:', error);
                console.error('Current data:', currentData);
                showAlert('Error updating charts: ' + error.message, 'error');
            }
        }

        // Process uploaded data for chart visualization
        function processDataForCharts(data) {
            console.log('Raw data received:', data);
            console.log('First row keys:', data[0] ? Object.keys(data[0]) : 'No data');
            
            // Skip header row if present and filter out invalid rows
            const cleanData = data.filter(row => {
                // Skip header row
                if (row.specimen_id === 'specimen_id') return false;
                
                // Check if row has essential data - be more flexible with column names
                const hasSpecimenId = row.specimen_id || row.specimen_id === 0;
                const hasDate = row.collection_date || row.date || row.Date;
                const hasDept = row.department || row.dept || row.Department;
                const hasTAT = row.tat_hours !== undefined && row.tat_hours !== null && row.tat_hours !== '';
                
                console.log('Row validation:', {
                    specimen_id: hasSpecimenId,
                    date: hasDate,
                    dept: hasDept,
                    tat: hasTAT,
                    row: row
                });
                
                return hasSpecimenId && hasDate && hasDept && hasTAT;
            });

            console.log('Clean data after filtering:', cleanData);

            if (cleanData.length === 0) {
                throw new Error('No valid data found for charting. Please ensure your CSV has specimen_id, collection_date, department, and tat_hours columns with valid data.');
            }

            // Group by date
            const dateGroups = {};
            const departmentGroups = {};
            
            cleanData.forEach(row => {
                // Be flexible with column names
                const date = row.collection_date || row.date || row.Date || 'Unknown';
                const dept = row.department || row.dept || row.Department || 'Unknown';
                const tat = parseFloat(row.tat_hours || row.tat || row.TAT || row.tat_hours);
                
                console.log('Processing row:', { date, dept, tat, originalRow: row });
                
                // Skip rows with invalid TAT values
                if (isNaN(tat)) {
                    console.warn('Skipping row with invalid TAT:', row);
                    return;
                }
                
                if (!dateGroups[date]) {
                    dateGroups[date] = { total: 0, count: 0, tatSum: 0 };
                }
                if (!departmentGroups[dept]) {
                    departmentGroups[dept] = { count: 0, errors: 0 };
                }
                
                dateGroups[date].total++;
                dateGroups[date].tatSum += tat;
                dateGroups[date].count++;
                
                departmentGroups[dept].count++;
                if (row.status === 'Error' || row.status === 'Critical') {
                    departmentGroups[dept].errors++;
                }
            });

            // Calculate metrics
            const dates = Object.keys(dateGroups).sort();
            const avgTAT = dates.map(date => 
                dateGroups[date].count > 0 ? 
                (dateGroups[date].tatSum / dateGroups[date].count).toFixed(2) : 0
            );
            const throughput = dates.map(date => dateGroups[date].total);
            
            const departments = Object.keys(departmentGroups);
            const errorRates = departments.map(dept => 
                departmentGroups[dept].count > 0 ? 
                (departmentGroups[dept].errors / departmentGroups[dept].count * 100).toFixed(1) : 0
            );

            return {
                dates: dates,
                avgTAT: avgTAT,
                throughput: throughput,
                departments: departments,
                errorRates: errorRates
            };
        }

        // Update summary metrics display
        function updateSummaryMetrics(data) {
            const totalSpecimens = data.throughput.reduce((sum, val) => sum + val, 0);
            const avgTATOverall = data.avgTAT.reduce((sum, val) => sum + parseFloat(val), 0) / data.avgTAT.length;
            
            // Update the summary cards if they exist
            const totalSpecimensEl = document.getElementById('totalSpecimens');
            const avgTATEl = document.getElementById('avgTAT');
            const totalDepartmentsEl = document.getElementById('totalDepartments');
            const dataQualityScoreEl = document.getElementById('dataQualityScore');
            
            if (totalSpecimensEl) totalSpecimensEl.textContent = totalSpecimens;
            if (avgTATEl) avgTATOverall > 0 ? avgTATEl.textContent = avgTATOverall.toFixed(2) + ' hrs' : avgTATEl.textContent = '0 hrs';
            if (totalDepartmentsEl) totalDepartmentsEl.textContent = data.departments.length;
            
            // Calculate data quality score based on validation results
            if (dataQualityScoreEl && currentData) {
                const validRecords = currentData.filter(row => 
                    row.specimen_id && 
                    row.specimen_id !== 'specimen_id' && 
                    row.collection_date && 
                    row.test_type && 
                    row.department
                ).length;
                const qualityScore = currentData.length > 1 ? Math.round((validRecords / (currentData.length - 1)) * 100) : 100;
                dataQualityScoreEl.textContent = qualityScore + '%';
            }
        }

        // Update data status display
        function updateDataStatus(message) {
            const dataStatusEl = document.getElementById('dataStatus');
            if (dataStatusEl) {
                dataStatusEl.textContent = message;
                dataStatusEl.style.color = '#28a745';
                dataStatusEl.style.fontStyle = 'normal';
            }
        }

        // Update data preview display
        function updateDataPreview(data) {
            const previewContainer = document.getElementById('dataPreview');
            if (!previewContainer) return;
            
            if (!data || data.length === 0) {
                previewContainer.innerHTML = '<p style="color: #666; font-style: italic;">No data available</p>';
                return;
            }
            
            // Show first 5 rows as preview
            const previewRows = data.slice(0, 5);
            const previewHtml = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>Total Records:</strong> ${data.length}</p>
                    <p><strong>Columns:</strong> ${Object.keys(data[0] || {}).join(', ')}</p>
                </div>
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                ${Object.keys(previewRows[0] || {}).map(col => `<th style="padding: 0.5rem; text-align: left; border: 1px solid #dee2e6;">${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${previewRows.map(row => `
                                <tr>
                                    ${Object.values(row).map(val => `<td style="padding: 0.5rem; border: 1px solid #dee2e6;">${val || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Manual Chart Update -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-primary" onclick="forceUpdateCharts()" style="margin-right: 1rem;">
                        🔄 Force Update Charts
                    </button>
                    <button class="btn btn-secondary" onclick="showDataDebug()">
                        🐛 Show Data Debug
                    </button>
                </div>
            `;
            
            previewContainer.innerHTML = previewHtml;
        }

        // Force update charts with current data
        function forceUpdateCharts() {
            if (!currentData || currentData.length === 0) {
                showAlert('No data available to update charts', 'warning');
                return;
            }
            
            showAlert('Forcing chart update...', 'info');
            updateDashboardCharts();
        }

        // Show data debugging information
        function showDataDebug() {
            if (!currentData || currentData.length === 0) {
                showAlert('No data available for debugging', 'warning');
                return;
            }
            
            const debugInfo = `
                <strong>Data Debug Information:</strong><br>
                • Total rows: ${currentData.length}<br>
                • First row keys: ${Object.keys(currentData[0] || {}).join(', ')}<br>
                • Sample first row: ${JSON.stringify(currentData[0], null, 2)}<br>
                • Sample second row: ${JSON.stringify(currentData[1], null, 2)}<br>
                • Current data type: ${typeof currentData}<br>
                • Is array: ${Array.isArray(currentData)}
            `;
            
            showAlert(debugInfo, 'info');
            console.log('Data Debug - Current Data:', currentData);
        }

        // Set current date in Teams Bot form
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Load sample lab data
        function loadSampleData() {
            const sampleData = [
                { specimen_id: 'SP001', collection_date: '2024-01-15', test_type: 'CBC', department: 'Hematology', tat_hours: 2.1, status: 'Completed', priority: 'Routine' },
                { specimen_id: 'SP002', collection_date: '2024-01-15', test_type: 'Chemistry Panel', department: 'Chemistry', tat_hours: 1.8, status: 'Completed', priority: 'Routine' },
                { specimen_id: 'SP003', collection_date: '2024-01-15', test_type: 'Blood Culture', department: 'Microbiology', tat_hours: 48.0, status: 'In Progress', priority: 'Urgent' },
                { specimen_id: 'SP004', collection_date: '2024-01-15', test_type: 'HIV Test', department: 'Immunology', tat_hours: 3.2, status: 'Completed', priority: 'Routine' },
                { specimen_id: 'SP005', collection_date: '2024-01-15', test_type: 'CBC', department: 'Hematology', tat_hours: 2.5, status: 'Completed', priority: 'Routine' }
            ];
            
            currentData = sampleData;
            updateDataStatus('Sample data loaded');
            showAlert('Sample data loaded successfully!', 'success');
            // Update dashboard charts with sample data
            updateDashboardCharts();
        }

        // Handle CSV file upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            console.log('CSV parsed successfully:', results.data);
                            console.log('Column headers:', results.data[0]);
                            
                            currentData = results.data;
                            updateDataStatus(`CSV uploaded: ${results.data.length} records`);
                            updateDataPreview(results.data);
                            showAlert('CSV file uploaded successfully!', 'success');
                            
                            // Try to update charts immediately
                            setTimeout(() => {
                                updateDashboardCharts();
                            }, 100);
                        } else {
                            showAlert('Error parsing CSV file', 'error');
                        }
                    },
                    error: function(error) {
                        showAlert('Error reading CSV file: ' + error.message, 'error');
                    }
                });
            }
        }

        // Add data quality rules
        function addRequiredColumnsRule() {
            const rule = {
                type: 'required_columns',
                name: 'Required Columns',
                description: 'Ensures all mandatory columns are present',
                columns: ['specimen_id', 'collection_date', 'test_type', 'department']
            };
            currentRules.push(rule);
            updateRulesDisplay();
            showAlert('Required columns rule added!', 'info');
        }

        function addDataTypeRule() {
            const rule = {
                type: 'data_type',
                name: 'Data Type Validation',
                description: 'Validates data types for each column',
                rules: {
                    specimen_id: 'string',
                    collection_date: 'date',
                    tat_hours: 'number',
                    patient_age: 'number',
                    quality_score: 'number'
                }
            };
            currentRules.push(rule);
            updateRulesDisplay();
            showAlert('Data type validation rule added!', 'info');
        }

        function addRangeRule() {
            const rule = {
                type: 'range',
                name: 'Range Validation',
                description: 'Checks values are within acceptable ranges',
                rules: {
                    tat_hours: { min: 0, max: 72 },
                    patient_age: { min: 0, max: 120 },
                    quality_score: { min: 0, max: 100 }
                }
            };
            currentRules.push(rule);
            updateRulesDisplay();
            showAlert('Range validation rule added!', 'info');
        }

        function addCompletenessRule() {
            const rule = {
                type: 'completeness',
                name: 'Completeness Check',
                description: 'Ensures no missing values in critical fields',
                columns: ['specimen_id', 'test_type', 'department', 'tat_hours']
            };
            currentRules.push(rule);
            updateRulesDisplay();
            showAlert('Completeness check rule added!', 'info');
        }

        // Update rules display
        function updateRulesDisplay() {
            const rulesContainer = document.getElementById('activeRules');
            if (!rulesContainer) return;
            
            if (currentRules.length === 0) {
                rulesContainer.innerHTML = '<p style="color: #666; font-style: italic;">No rules added yet. Click the buttons above to add validation rules.</p>';
                return;
            }
            
            rulesContainer.innerHTML = currentRules.map((rule, index) => `
                <div class="rule-item active" style="border-left-color: #28a745;">
                    <div class="rule-header">
                        <span class="rule-type">${rule.type.toUpperCase()}</span>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="removeRule(${index})">Remove</button>
                    </div>
                    <div class="rule-details">
                        <strong>${rule.name}</strong><br>
                        ${rule.description}
                    </div>
                </div>
            `).join('');
        }

        // Remove rule
        function removeRule(index) {
            currentRules.splice(index, 1);
            updateRulesDisplay();
            showAlert('Rule removed!', 'info');
        }

        // Custom rule builder
        function updateCustomRuleParams() {
            const ruleType = document.getElementById('customRuleType').value;
            const paramsContainer = document.getElementById('customRuleParams');
            
            let html = '';
            switch(ruleType) {
                case 'custom_range':
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Minimum Value:</label>
                                <input type="number" id="customMin" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Maximum Value:</label>
                                <input type="number" id="customMax" placeholder="100" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    `;
                    break;
                case 'custom_completeness':
                    html = `
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Required Columns (comma-separated):</label>
                            <input type="text" id="customColumns" placeholder="specimen_id, test_type, department" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                    break;
                case 'custom_format':
                    html = `
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Expected Format:</label>
                            <select id="customFormat" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="email">Email Address</option>
                                <option value="phone">Phone Number</option>
                                <option value="date">Date (YYYY-MM-DD)</option>
                                <option value="time">Time (HH:MM)</option>
                                <option value="numeric">Numeric Only</option>
                                <option value="alphanumeric">Alphanumeric</option>
                            </select>
                        </div>
                    `;
                    break;
            }
            paramsContainer.innerHTML = html;
        }

        function addCustomRule() {
            const ruleType = document.getElementById('customRuleType').value;
            const column = document.getElementById('customColumn').value.trim();
            
            if (!column) {
                showAlert('Please enter a column name!', 'error');
                return;
            }
            
            let rule;
            switch(ruleType) {
                case 'custom_range':
                    const min = parseFloat(document.getElementById('customMin').value);
                    const max = parseFloat(document.getElementById('customMax').value);
                    if (isNaN(min) || isNaN(max)) {
                        showAlert('Please enter valid min and max values!', 'error');
                        return;
                    }
                    rule = {
                        type: 'custom_range',
                        name: `Custom Range: ${column}`,
                        description: `Ensures ${column} is between ${min} and ${max}`,
                        column: column,
                        min: min,
                        max: max
                    };
                    break;
                case 'custom_completeness':
                    const columns = document.getElementById('customColumns').value.split(',').map(c => c.trim()).filter(c => c);
                    if (columns.length === 0) {
                        showAlert('Please enter at least one column name!', 'error');
                        return;
                    }
                    rule = {
                        type: 'custom_completeness',
                        name: `Custom Completeness: ${columns.join(', ')}`,
                        description: `Ensures no missing values in columns: ${columns.join(', ')}`,
                        columns: columns
                    };
                    break;
                case 'custom_format':
                    const format = document.getElementById('customFormat').value;
                    rule = {
                        type: 'custom_format',
                        name: `Custom Format: ${column}`,
                        description: `Validates ${column} format: ${format}`,
                        column: column,
                        format: format
                    };
                    break;
            }
            
            if (rule) {
                currentRules.push(rule);
                updateRulesDisplay();
                showAlert('Custom rule added successfully!', 'success');
                // Clear form
                document.getElementById('customColumn').value = '';
                document.getElementById('customRuleParams').innerHTML = '';
            }
        }

        // Format validation helper
        function validateFormat(value, format) {
            switch(format) {
                case 'email':
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                case 'phone':
                    return /^[\+]?[1-9][\d]{0,15}$/.test(value.replace(/[\s\-\(\)]/g, ''));
                case 'date':
                    return /^\d{4}-\d{2}-\d{2}$/.test(value);
                case 'time':
                    return /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value);
                case 'numeric':
                    return /^\d+(\.\d+)?$/.test(value);
                case 'alphanumeric':
                    return /^[a-zA-Z0-9\s]+$/.test(value);
                default:
                    return true;
            }
        }

        // Toggle rule based on checkbox
        function toggleRule(ruleType) {
            const checkbox = document.getElementById(`rule-${ruleType.split('_')[1]}`);
            const isChecked = checkbox.checked;
            
            if (isChecked) {
                // Add rule
                switch(ruleType) {
                    case 'required_columns':
                        addRequiredColumnsRule();
                        break;
                    case 'data_type':
                        addDataTypeRule();
                        break;
                    case 'range':
                        addRangeRule();
                        break;
                    case 'completeness':
                        addCompletenessRule();
                        break;
                }
                checkbox.parentElement.classList.add('checked');
            } else {
                // Remove rule
                const ruleIndex = currentRules.findIndex(rule => rule.type === ruleType);
                if (ruleIndex !== -1) {
                    currentRules.splice(ruleIndex, 1);
                    updateRulesDisplay();
                    showAlert('Rule removed!', 'info');
                }
                checkbox.parentElement.classList.remove('checked');
            }
        }

        // Upload rules file
        function uploadRulesFile() {
            const fileInput = document.getElementById('rulesFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select a rules file first!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let rules;
                    if (file.name.endsWith('.json')) {
                        rules = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) {
                        // Simple YAML parsing for basic rules
                        rules = parseSimpleYAML(e.target.result);
                    } else {
                        showAlert('Unsupported file format. Please use JSON or YAML.', 'error');
                        return;
                    }
                    
                    if (Array.isArray(rules)) {
                        currentRules = rules;
                        updateRulesDisplay();
                        updateCheckboxesFromRules();
                        showAlert(`Successfully loaded ${rules.length} rules!`, 'success');
                    } else {
                        showAlert('Invalid rules format. File should contain an array of rules.', 'error');
                    }
                } catch (error) {
                    showAlert('Error parsing rules file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Parse simple YAML (basic implementation)
        function parseSimpleYAML(yamlText) {
            const rules = [];
            const lines = yamlText.split('\n');
            let currentRule = null;
            
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('- type:')) {
                    if (currentRule) rules.push(currentRule);
                    currentRule = { type: line.split(':')[1].trim() };
                } else if (line.includes(':') && currentRule) {
                    const [key, value] = line.split(':').map(s => s.trim());
                    if (key === 'columns' && value.includes('[')) {
                        currentRule[key] = value.replace(/[\[\]]/g, '').split(',').map(s => s.trim());
                    } else if (key === 'rules' && value.includes('{')) {
                        // Parse nested rules object
                        const rulesText = value.replace(/[{}]/g, '');
                        const rulesObj = {};
                        rulesText.split(',').forEach(rule => {
                            const [k, v] = rule.split(':').map(s => s.trim());
                            if (k && v) rulesObj[k] = v;
                        });
                        currentRule[key] = rulesObj;
                    } else {
                        currentRule[key] = value;
                    }
                }
            }
            
            if (currentRule) rules.push(currentRule);
            return rules;
        }

        // Download sample rules
        function downloadSampleRules() {
            const sampleRules = [
                {
                    type: 'required_columns',
                    name: 'Required Columns',
                    description: 'Ensures all mandatory columns are present',
                    columns: ['specimen_id', 'collection_date', 'test_type', 'department']
                },
                {
                    type: 'data_type',
                    name: 'Data Type Validation',
                    description: 'Validates data types for each column',
                    rules: {
                        specimen_id: 'string',
                        collection_date: 'date',
                        tat_hours: 'number'
                    }
                },
                {
                    type: 'range',
                    name: 'Range Validation',
                    description: 'Checks values are within acceptable ranges',
                    rules: {
                        tat_hours: { min: 0, max: 72 }
                    }
                },
                {
                    type: 'completeness',
                    name: 'Completeness Check',
                    description: 'Ensures no missing values in critical fields',
                    columns: ['specimen_id', 'test_type', 'department']
                }
            ];
            
            const blob = new Blob([JSON.stringify(sampleRules, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_data_quality_rules.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Update checkboxes based on current rules
        function updateCheckboxesFromRules() {
            const checkboxes = {
                'required_columns': 'rule-required',
                'data_type': 'rule-datatype',
                'range': 'rule-range',
                'completeness': 'rule-completeness'
            };
            
            Object.entries(checkboxes).forEach(([ruleType, checkboxId]) => {
                const checkbox = document.getElementById(checkboxId);
                const hasRule = currentRules.some(rule => rule.type === ruleType);
                checkbox.checked = hasRule;
                checkbox.parentElement.classList.toggle('checked', hasRule);
            });
        }

        // Initialize custom rule builder
        document.addEventListener('DOMContentLoaded', function() {
            const customRuleType = document.getElementById('customRuleType');
            if (customRuleType) {
                customRuleType.addEventListener('change', updateCustomRuleParams);
                updateCustomRuleParams(); // Initial load
            }
        });

        // Run data quality validation
        function runValidation() {
            if (!currentData || currentData.length === 0) {
                showAlert('Please load data first!', 'error');
                return;
            }

            if (currentRules.length === 0) {
                showAlert('Please add at least one validation rule!', 'error');
                return;
            }

            // Show loading state
            const btn = document.getElementById('runValidationBtn');
            btn.innerHTML = '<div class="spinner"></div> Running Validation...';
            btn.disabled = true;

            // Simulate validation process
            setTimeout(() => {
                const violations = performValidation(currentData, currentRules);
                displayValidationResults(violations);
                
                // Reset button
                btn.innerHTML = '🚀 Run Data Quality Validation';
                btn.disabled = false;
            }, 2000);
        }

        // Perform validation logic
        function performValidation(data, rules) {
            const violations = [];
            
            rules.forEach(rule => {
                switch (rule.type) {
                    case 'required_columns':
                        const missingColumns = rule.columns.filter(col => 
                            !data[0] || !(col in data[0])
                        );
                        if (missingColumns.length > 0) {
                            violations.push({
                                type: 'error',
                                message: `Missing required columns: ${missingColumns.join(', ')}`,
                                details: `Rule: ${rule.name}`
                            });
                        }
                        break;
                        
                    case 'completeness':
                        rule.columns.forEach(col => {
                            const missingValues = data.filter(row => 
                                !row[col] || row[col].toString().trim() === ''
                            );
                            if (missingValues.length > 0) {
                                violations.push({
                                    type: 'warning',
                                    message: `Missing values in column: ${col}`,
                                    details: `${missingValues.length} rows have missing values`
                                });
                            }
                        });
                        break;
                        
                                            case 'range':
                            Object.entries(rule.rules).forEach(([col, range]) => {
                                const outOfRange = data.filter(row => {
                                    const value = parseFloat(row[col]);
                                    return isNaN(value) || value < range.min || value > range.max;
                                });
                                if (outOfRange.length > 0) {
                                    violations.push({
                                        type: 'error',
                                        message: `Values out of range in column: ${col}`,
                                        details: `${outOfRange.length} rows have values outside ${range.min}-${range.max}`
                                    });
                                }
                            });
                            break;
                        case 'custom_range':
                            const outOfRange = data.filter(row => {
                                const value = parseFloat(row[rule.column]);
                                return isNaN(value) || value < rule.min || value > rule.max;
                            });
                            if (outOfRange.length > 0) {
                                violations.push({
                                    type: 'error',
                                    message: `Values out of range in column: ${rule.column}`,
                                    details: `${outOfRange.length} rows have values outside ${rule.min}-${rule.max}`
                                });
                            }
                            break;
                        case 'custom_completeness':
                            rule.columns.forEach(col => {
                                const missingValues = data.filter(row => 
                                    !row[col] || row[col].toString().trim() === ''
                                );
                                if (missingValues.length > 0) {
                                    violations.push({
                                        type: 'warning',
                                        message: `Missing values in column: ${col}`,
                                        details: `${missingValues.length} rows have missing values`
                                    });
                                }
                            });
                            break;
                        case 'custom_format':
                            const invalidFormat = data.filter(row => {
                                const value = row[rule.column];
                                if (!value) return false;
                                return !validateFormat(value, rule.format);
                            });
                            if (invalidFormat.length > 0) {
                                violations.push({
                                    type: 'warning',
                                    message: `Invalid format in column: ${rule.column}`,
                                    details: `${invalidFormat.length} rows have invalid ${rule.format} format`
                                });
                            }
                            break;
                }
            });
            
            return violations;
        }

        // Display validation results
        function displayValidationResults(violations) {
            const resultsContainer = document.getElementById('validationResults');
            const violationsList = document.getElementById('violationsList');
            
            if (violations.length === 0) {
                violationsList.innerHTML = '<div class="alert alert-success">✅ All validation rules passed! No violations found.</div>';
            } else {
                violationsList.innerHTML = violations.map(violation => `
                    <div class="violation-item ${violation.type}">
                        <div class="violation-header">
                            <span class="violation-type ${violation.type}">${violation.type.toUpperCase()}</span>
                        </div>
                        <div class="violation-details">
                            <strong>${violation.message}</strong><br>
                            ${violation.details}
                        </div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        // Export validation results
        function exportResults() {
            const violationsList = document.getElementById('violationsList');
            const content = violationsList.innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation-results.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear validation results
        function clearResults() {
            document.getElementById('validationResults').style.display = 'none';
            document.getElementById('violationsList').innerHTML = '';
        }

        // Teams Bot functions
        function previewMessage() {
            const form = document.getElementById('standupForm');
            const formData = new FormData(form);
            
            const message = generateTeamsMessage(formData);
            document.getElementById('previewContent').innerHTML = message;
            document.getElementById('messagePreview').style.display = 'block';
        }

        function generateTeamsMessage(formData) {
            const teamName = formData.get('teamName') || 'Team';
            const date = formData.get('date') || 'Today';
            const yesterday = formData.get('yesterday') || 'Completed various tasks';
            const today = formData.get('today') || 'Working on current priorities';
            const blockers = formData.get('blockers') || 'None';
            const template = formData.get('template') || 'professional';
            
            let message = `<strong>📊 ${teamName} - Daily Stand-up</strong><br>`;
            message += `<em>Date: ${date}</em><br><br>`;
            
            message += `<strong>✅ Yesterday's Accomplishments:</strong><br>`;
            message += `${yesterday}<br><br>`;
            
            message += `<strong>🎯 Today's Priorities:</strong><br>`;
            message += `${today}<br><br>`;
            
            if (blockers && blockers.trim() !== '') {
                message += `<strong>🚧 Blockers/Challenges:</strong><br>`;
                message += `${blockers}<br><br>`;
            }
            
            message += `<em>Generated by LabOps Metrics Starter Kit</em>`;
            
            return message;
        }

        function sendToTeams() {
            // Simulate sending to Teams
            document.getElementById('successMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 5000);
        }

        function loadSampleStandup() {
            document.getElementById('yesterday').value = 'Completed 150 specimen tests, resolved 3 equipment issues, updated SOP documentation for new protocols.';
            document.getElementById('today').value = 'Process 180 scheduled tests, conduct quality control checks, train new technician on automated systems.';
            document.getElementById('blockers').value = 'Waiting for reagent delivery (expected by 2 PM), one analyzer needs calibration.';
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // File upload drag and drop
        const fileUpload = document.getElementById('fileUpload');
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                document.getElementById('csvFile').files = files;
                handleCSVUpload({ target: { files: files } });
            }
        });
    </script>
</body>
</html>
